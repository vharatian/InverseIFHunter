<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Model Hunter â€” Test Dashboard</title>
<style>
/* ========== CSS Variables (Notion-Minimal Theme) ========== */
:root {
    --bg: #ffffff;
    --bg-secondary: #f7f7f5;
    --bg-tertiary: #f0f0ed;
    --text: #37352f;
    --text-secondary: #6b6b6b;
    --text-muted: #9b9b9b;
    --border: #e8e8e4;
    --border-strong: #d4d4d0;
    --accent: #2383e2;
    --accent-bg: #e8f0fe;
    --green: #4caf50;
    --green-bg: #e8f5e9;
    --red: #e53935;
    --red-bg: #fbe9e7;
    --orange: #ff9800;
    --orange-bg: #fff3e0;
    --purple: #7c3aed;
    --purple-bg: #ede9fe;
    --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --radius: 8px;
    --radius-sm: 4px;
    --shadow: 0 1px 3px rgba(0,0,0,0.06);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
}

[data-theme="dark"] {
    --bg: #191919;
    --bg-secondary: #202020;
    --bg-tertiary: #2a2a2a;
    --text: #e0e0e0;
    --text-secondary: #a0a0a0;
    --text-muted: #666;
    --border: #333;
    --border-strong: #444;
    --accent: #529cca;
    --accent-bg: #1a2f44;
    --green: #66bb6a;
    --green-bg: #1b3a1b;
    --red: #ef5350;
    --red-bg: #3a1b1b;
    --orange: #ffa726;
    --orange-bg: #3a2e1b;
    --purple: #a78bfa;
    --purple-bg: #2a1f44;
    --shadow: 0 1px 3px rgba(0,0,0,0.3);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
}

/* ========== Header ========== */
.header {
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.header-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
}

.header-subtitle {
    font-size: 12px;
    color: var(--text-muted);
}

.header-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* ========== Status Pill ========== */
.status-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid var(--border);
    background: var(--bg-secondary);
    color: var(--text-secondary);
}

.status-pill.running {
    background: var(--accent-bg);
    border-color: var(--accent);
    color: var(--accent);
}

.status-pill.passed {
    background: var(--green-bg);
    border-color: var(--green);
    color: var(--green);
}

.status-pill.failed {
    background: var(--red-bg);
    border-color: var(--red);
    color: var(--red);
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
}

.status-pill.running .status-dot {
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

/* ========== Buttons ========== */
.btn {
    padding: 6px 14px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    font-family: var(--font);
}

.btn:hover {
    background: var(--bg-secondary);
    border-color: var(--border-strong);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-primary {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
}

.btn-primary:hover {
    opacity: 0.9;
    background: var(--accent);
}

.btn-danger {
    color: var(--red);
    border-color: var(--red);
}

.btn-sm {
    padding: 3px 8px;
    font-size: 11px;
}

.theme-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
}

/* ========== Run Controls ========== */
.controls {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-secondary);
    flex-wrap: wrap;
}

.controls-label {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* ========== Main Layout ========== */
.main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
}

/* ========== Summary Cards ========== */
.summary-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
}

.summary-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    text-align: center;
}

.summary-card .value {
    font-size: 28px;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
}

.summary-card .label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.summary-card.total .value { color: var(--text); }
.summary-card.passed .value { color: var(--green); }
.summary-card.failed .value { color: var(--red); }
.summary-card.time .value { color: var(--accent); }
.summary-card.skipped .value { color: var(--orange); }

/* ========== Section Headers ========== */
.section-header {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
}

/* ========== Test Grid ========== */
.grid-section {
    margin-bottom: 32px;
}

.category-group {
    margin-bottom: 20px;
}

.category-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.category-count {
    font-weight: 400;
    color: var(--text-muted);
}

.test-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
}

.test-cell {
    width: 28px;
    height: 28px;
    border-radius: 3px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.test-cell:hover {
    transform: scale(1.3);
    z-index: 10;
    box-shadow: var(--shadow-md);
}

.test-cell.running {
    background: var(--accent-bg);
    border-color: var(--accent);
    animation: cellPulse 1s infinite;
}

.test-cell.passed {
    background: var(--green);
    border-color: var(--green);
}

.test-cell.failed {
    background: var(--red);
    border-color: var(--red);
    animation: cellFail 0.5s ease;
}

.test-cell.skipped {
    background: var(--orange);
    border-color: var(--orange);
    opacity: 0.6;
}

.test-cell.error {
    background: var(--red);
    border-color: var(--red);
}

@keyframes cellPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes cellFail {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1); }
}

/* Tooltip */
.test-cell .tooltip {
    display: none;
    position: absolute;
    bottom: 110%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--text);
    color: var(--bg);
    padding: 6px 10px;
    border-radius: var(--radius-sm);
    font-size: 11px;
    white-space: nowrap;
    z-index: 1000;
    pointer-events: none;
}

.test-cell:hover .tooltip {
    display: block;
}

/* ========== Category Breakdown Bar ========== */
.breakdown-section {
    margin-bottom: 32px;
}

.breakdown-bar {
    display: flex;
    height: 32px;
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border);
    margin-bottom: 8px;
}

.breakdown-segment {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    color: #fff;
    transition: width 0.5s ease;
    min-width: 0;
    overflow: hidden;
}

.breakdown-legend {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text-secondary);
}

.legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 2px;
}

/* ========== Trend Chart ========== */
.trend-section {
    margin-bottom: 32px;
}

.trend-chart {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    height: 200px;
    position: relative;
    overflow: hidden;
}

.trend-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-muted);
    font-size: 13px;
}

.trend-svg {
    width: 100%;
    height: 100%;
}

/* ========== Failed Tests Panel ========== */
.failures-section {
    margin-bottom: 32px;
}

.failure-card {
    background: var(--bg);
    border: 1px solid var(--red);
    border-left: 4px solid var(--red);
    border-radius: var(--radius);
    padding: 12px 16px;
    margin-bottom: 8px;
}

.failure-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
}

.failure-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--red);
    font-family: 'SF Mono', 'Fira Code', monospace;
}

.failure-duration {
    font-size: 11px;
    color: var(--text-muted);
}

.failure-error {
    font-size: 12px;
    color: var(--text-secondary);
    background: var(--bg-tertiary);
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    font-family: 'SF Mono', 'Fira Code', monospace;
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 200px;
    overflow-y: auto;
}

.copy-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
    font-size: 12px;
    padding: 2px 6px;
}

.copy-btn:hover { color: var(--accent); }

/* ========== Progress Bar ========== */
.progress-bar-container {
    width: 100%;
    height: 4px;
    background: var(--bg-tertiary);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 8px;
}

.progress-bar-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.3s ease;
    width: 0%;
}

/* ========== Empty State ========== */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
}

.empty-state-icon {
    font-size: 48px;
    margin-bottom: 12px;
}

.empty-state-text {
    font-size: 14px;
    margin-bottom: 4px;
}

.empty-state-hint {
    font-size: 12px;
    color: var(--text-muted);
}

/* ========== Live Terminal ========== */
.terminal-section {
    margin-bottom: 32px;
}

.terminal-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    user-select: none;
}

.terminal-toggle .chevron {
    font-size: 11px;
    color: var(--text-muted);
    transition: transform 0.2s;
}

.terminal-toggle.open .chevron { transform: rotate(90deg); }

.terminal-body {
    background: #0d1117;
    border: 1px solid #21262d;
    border-radius: var(--radius);
    margin-top: 8px;
    max-height: 320px;
    overflow-y: auto;
    display: none;
}

.terminal-body.open { display: block; }

.terminal-content {
    padding: 12px 16px;
    font-family: 'SF Mono', 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 12px;
    line-height: 1.6;
    color: #c9d1d9;
    white-space: pre-wrap;
    word-break: break-all;
}

.terminal-content .line-pass { color: #3fb950; }
.terminal-content .line-fail { color: #f85149; }
.terminal-content .line-skip { color: #d29922; }
.terminal-content .line-info { color: #58a6ff; }
.terminal-content .line-time { color: #6e7681; font-size: 10px; }

/* ========== Detail Side Panel ========== */
.detail-overlay {
    display: none;
    position: fixed;
    top: 0; right: 0; bottom: 0; left: 0;
    background: rgba(0,0,0,0.3);
    z-index: 200;
}

.detail-overlay.open { display: block; }

.detail-panel {
    position: fixed;
    top: 0;
    right: -440px;
    width: 440px;
    height: 100vh;
    background: var(--bg);
    border-left: 1px solid var(--border);
    box-shadow: -8px 0 24px rgba(0,0,0,0.15);
    z-index: 300;
    transition: right 0.25s cubic-bezier(0.16, 1, 0.3, 1);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.detail-panel.open { right: 0; }

.detail-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
    flex-shrink: 0;
}

.detail-close {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: var(--text-muted);
    padding: 2px 6px;
    border-radius: 4px;
    flex-shrink: 0;
}

.detail-close:hover { background: var(--bg-tertiary); color: var(--text); }

.detail-title {
    font-size: 14px;
    font-weight: 600;
    word-break: break-all;
    font-family: 'SF Mono', 'Fira Code', monospace;
}

.detail-body { padding: 16px 20px; flex: 1; }

.detail-row {
    margin-bottom: 16px;
}

.detail-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.detail-value {
    font-size: 13px;
    color: var(--text);
}

.detail-file-link {
    color: var(--accent);
    text-decoration: none;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 12px;
}

.detail-file-link:hover { text-decoration: underline; }

.detail-badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.detail-badge.passed { background: var(--green-bg); color: var(--green); }
.detail-badge.failed { background: var(--red-bg); color: var(--red); }
.detail-badge.pending { background: var(--bg-tertiary); color: var(--text-muted); }
.detail-badge.skipped { background: var(--orange-bg); color: var(--orange); }

.detail-source {
    background: #0d1117;
    border: 1px solid #21262d;
    border-radius: var(--radius-sm);
    padding: 12px;
    font-family: 'SF Mono', 'JetBrains Mono', monospace;
    font-size: 12px;
    line-height: 1.6;
    color: #c9d1d9;
    white-space: pre-wrap;
    overflow-x: auto;
    max-height: 400px;
    overflow-y: auto;
}

.detail-docstring {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
    font-size: 13px;
    color: var(--text-secondary);
    font-style: italic;
}

.detail-error {
    background: var(--red-bg);
    border: 1px solid var(--red);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 12px;
    color: var(--red);
    white-space: pre-wrap;
    max-height: 250px;
    overflow-y: auto;
}

/* ========== AI Test Creator Modal ========== */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0; right: 0; bottom: 0; left: 0;
    background: rgba(0,0,0,0.5);
    z-index: 400;
    align-items: center;
    justify-content: center;
}

.modal-overlay.open { display: flex; }

.modal {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 720px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    font-size: 16px;
    font-weight: 600;
}

.modal-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--text-muted);
    padding: 2px 8px;
    border-radius: 4px;
}

.modal-close:hover { background: var(--bg-tertiary); }

.modal-body { padding: 24px; }

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 6px;
}

.form-select, .form-input, .form-textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    font-size: 13px;
}

.form-select:focus, .form-input:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-bg);
}

.form-textarea {
    min-height: 80px;
    resize: vertical;
}

.code-preview {
    background: #0d1117;
    border: 1px solid #21262d;
    border-radius: var(--radius);
    padding: 16px;
    font-family: 'SF Mono', 'JetBrains Mono', monospace;
    font-size: 12px;
    line-height: 1.6;
    color: #c9d1d9;
    white-space: pre-wrap;
    max-height: 400px;
    overflow-y: auto;
    min-height: 200px;
}

.code-preview[contenteditable="true"] {
    outline: none;
    border-color: var(--accent);
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
}

.modal-footer-left { display: flex; align-items: center; gap: 8px; }
.modal-footer-right { display: flex; align-items: center; gap: 8px; }

.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.btn-success {
    background: var(--green);
    color: #fff;
    border-color: var(--green);
}

.btn-success:hover { opacity: 0.9; background: var(--green); }

.btn-purple {
    background: var(--purple);
    color: #fff;
    border-color: var(--purple);
}

.btn-purple:hover { opacity: 0.9; background: var(--purple); }

/* ========== Responsive ========== */
@media (max-width: 768px) {
    .header { padding: 10px 16px; }
    .controls { padding: 12px 16px; }
    .main { padding: 16px; }
    .summary-row { grid-template-columns: repeat(2, 1fr); }
    .test-cell { width: 22px; height: 22px; }
    .detail-panel { width: 100%; right: -100%; }
    .modal { width: 95%; margin: 10px; }
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- Header -->
<div class="header">
    <div class="header-left">
        <div>
            <div class="header-title">Model Hunter â€” Test Dashboard</div>
            <div class="header-subtitle" id="lastRunTime">No runs yet</div>
        </div>
    </div>
    <div class="header-right">
        <div class="status-pill" id="statusPill">
            <span class="status-dot"></span>
            <span id="statusText">Idle</span>
        </div>
        <button class="theme-btn" id="themeToggle" title="Toggle theme">ðŸŒ“</button>
    </div>
</div>

<!-- Run Controls -->
<div class="controls">
    <span class="controls-label">Run:</span>
    <button class="btn btn-primary" id="btnRunAll" onclick="runTests('all')">All Tests</button>
    <button class="btn" onclick="runTests('unit')">Unit</button>
    <button class="btn" onclick="runTests('api')">API</button>
    <button class="btn" onclick="runTests('stress')">Stress</button>
    <button class="btn" onclick="runTests('e2e')">E2E</button>
    <button class="btn" onclick="runTests('security')">Security</button>
    <button class="btn btn-danger" id="btnCancel" onclick="cancelTests()" disabled>Cancel</button>
    <div class="progress-bar-container" id="progressContainer" style="flex:1;max-width:300px;">
        <div class="progress-bar-fill" id="progressFill"></div>
    </div>
    <span style="flex:1;"></span>
    <button class="btn btn-purple" onclick="openTestCreator()">+ New Test</button>
</div>

<!-- Main Content -->
<div class="main">

    <!-- Summary Cards -->
    <div class="summary-row" id="summaryRow">
        <div class="summary-card total">
            <div class="value" id="totalCount">-</div>
            <div class="label">Total</div>
        </div>
        <div class="summary-card passed">
            <div class="value" id="passedCount">-</div>
            <div class="label">Passed</div>
        </div>
        <div class="summary-card failed">
            <div class="value" id="failedCount">-</div>
            <div class="label">Failed</div>
        </div>
        <div class="summary-card skipped">
            <div class="value" id="skippedCount">-</div>
            <div class="label">Skipped</div>
        </div>
        <div class="summary-card time">
            <div class="value" id="timeValue">-</div>
            <div class="label">Duration</div>
        </div>
    </div>

    <!-- Test Grid -->
    <div class="grid-section" id="gridSection">
        <div class="section-header">Test Grid</div>
        <div id="testGridContainer">
            <div class="empty-state">
                <div class="empty-state-icon">&#9744;</div>
                <div class="empty-state-text">No tests discovered yet</div>
                <div class="empty-state-hint">Click "All Tests" to discover and run tests</div>
            </div>
        </div>
    </div>

    <!-- Live Terminal Output -->
    <div class="terminal-section">
        <div class="section-header terminal-toggle" id="terminalToggle" onclick="toggleTerminal()">
            Live Output <span class="chevron">&#9654;</span>
        </div>
        <div class="terminal-body" id="terminalBody">
            <div class="terminal-content" id="terminalContent">Waiting for test run...</div>
        </div>
    </div>

    <!-- Category Breakdown -->
    <div class="breakdown-section" id="breakdownSection" style="display:none;">
        <div class="section-header">Category Breakdown</div>
        <div class="breakdown-bar" id="breakdownBar"></div>
        <div class="breakdown-legend" id="breakdownLegend"></div>
    </div>

    <!-- Trend Chart -->
    <div class="trend-section">
        <div class="section-header">Trend (Last 20 Runs)</div>
        <div class="trend-chart" id="trendChart">
            <div class="trend-empty">Run tests to build trend data</div>
        </div>
    </div>

    <!-- Failed Tests Panel -->
    <div class="failures-section" id="failuresSection" style="display:none;">
        <div class="section-header">Failed Tests</div>
        <div id="failuresContainer"></div>
    </div>
</div>

<!-- Detail Side Panel -->
<div class="detail-overlay" id="detailOverlay" onclick="closeDetail()"></div>
<div class="detail-panel" id="detailPanel">
    <div class="detail-header">
        <div>
            <div class="detail-title" id="detailTitle">-</div>
        </div>
        <button class="detail-close" onclick="closeDetail()">&times;</button>
    </div>
    <div class="detail-body" id="detailBody">
        <p style="color:var(--text-muted); font-size:13px;">Click a test cell to view details.</p>
    </div>
</div>

<!-- AI Test Creator Modal -->
<div class="modal-overlay" id="aiModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">AI Test Generator</span>
            <button class="modal-close" onclick="closeTestCreator()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="aiCategory">
                    <option value="api">API</option>
                    <option value="unit">Unit</option>
                    <option value="e2e">E2E</option>
                    <option value="stress">Stress</option>
                    <option value="security">Security</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Describe the test in plain English</label>
                <textarea class="form-textarea" id="aiDescription" placeholder="e.g. Test that uploading an empty notebook returns a 400 error with a helpful message"></textarea>
            </div>
            <div class="form-group" id="aiCodeGroup" style="display:none;">
                <label class="form-label">
                    Generated Code
                    <button class="btn btn-sm" style="margin-left:8px;" onclick="toggleCodeEdit()">Edit</button>
                </label>
                <div class="code-preview" id="aiCodePreview"></div>
            </div>
            <div class="form-group" id="aiFilenameGroup" style="display:none;">
                <label class="form-label">Filename</label>
                <input class="form-input" id="aiFilename" placeholder="test_something.py">
            </div>
        </div>
        <div class="modal-footer">
            <div class="modal-footer-left">
                <span id="aiStatus" style="font-size:12px;color:var(--text-muted);"></span>
            </div>
            <div class="modal-footer-right">
                <button class="btn btn-primary" id="btnGenerate" onclick="generateTest()">Generate</button>
                <button class="btn btn-success" id="btnSaveRun" onclick="saveAndRunTest()" style="display:none;">Save &amp; Run</button>
            </div>
        </div>
    </div>
</div>

<script>
/* ========== State ========== */
const state = {
    tests: [],
    testMap: {},  // nodeid â†’ {element, status, category, file, name}
    testDetails: {},  // nodeid â†’ {outcome, duration, error, ...} from run_complete
    totalDiscovered: 0,
    completed: 0,
    passed: 0,
    failed: 0,
    skipped: 0,
    running: false,
    eventSource: null,
    categoryCounts: {},
    categoryResults: {},
};

/* ========== Theme ========== */
(function initTheme() {
    const saved = localStorage.getItem('test-dashboard-theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);
})();

document.getElementById('themeToggle').addEventListener('click', () => {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    localStorage.setItem('test-dashboard-theme', next);
});

/* ========== Discover Tests ========== */
async function discoverTests(category) {
    try {
        const r = await fetch(`/api/list-tests?category=${category}`);
        const data = await r.json();
        if (data.error) return;

        state.totalDiscovered = data.total;
        state.categoryCounts = data.category_counts || {};

        // Build grid
        const container = document.getElementById('testGridContainer');
        container.innerHTML = '';

        const categories = data.categories || {};
        const catOrder = ['unit', 'api', 'stress', 'integration', 'security', 'e2e', 'other'];

        for (const cat of catOrder) {
            const tests = categories[cat];
            if (!tests || tests.length === 0) continue;

            const group = document.createElement('div');
            group.className = 'category-group';

            const label = document.createElement('div');
            label.className = 'category-label';
            label.innerHTML = `${cat.toUpperCase()} <span class="category-count">(${tests.length})</span>`;
            group.appendChild(label);

            const grid = document.createElement('div');
            grid.className = 'test-grid';

            for (const t of tests) {
                const cell = document.createElement('div');
                cell.className = 'test-cell';
                cell.dataset.nodeid = t.nodeid;

                const tooltip = document.createElement('span');
                tooltip.className = 'tooltip';
                tooltip.textContent = `${t.name} (${t.file})`;
                cell.appendChild(tooltip);

                cell.addEventListener('click', () => openDetail(t.nodeid));
                grid.appendChild(cell);

                state.testMap[t.nodeid] = { element: cell, status: 'pending', category: cat, file: t.file, name: t.name };
            }

            group.appendChild(grid);
            container.appendChild(group);
        }

        document.getElementById('totalCount').textContent = data.total;
    } catch (e) {
        console.error('Failed to discover tests:', e);
    }
}

/* ========== Run Tests ========== */
async function runTests(category) {
    if (state.running) return;
    state.running = true;

    // Reset state
    state.completed = 0;
    state.passed = 0;
    state.failed = 0;
    state.skipped = 0;
    state.categoryResults = {};

    // UI updates
    setStatus('running', 'Running...');
    document.getElementById('btnCancel').disabled = false;
    document.querySelectorAll('.controls .btn:not(.btn-danger)').forEach(b => b.disabled = true);
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('failuresSection').style.display = 'none';
    document.getElementById('failuresContainer').innerHTML = '';
    updateSummary();

    // Reset all cells and terminal
    Object.values(state.testMap).forEach(t => {
        t.element.className = 'test-cell';
        t.status = 'pending';
    });
    state.testDetails = {};
    clearTerminal();
    openTerminal();

    // Discover tests first
    await discoverTests(category);

    // Connect SSE
    if (state.eventSource) state.eventSource.close();
    state.eventSource = new EventSource(`/api/run-tests?category=${category}`);

    state.eventSource.addEventListener('raw_output', (e) => {
        const data = JSON.parse(e.data);
        appendTerminalLine(data.line, data.elapsed);
    });

    state.eventSource.addEventListener('test_result', (e) => {
        const data = JSON.parse(e.data);
        handleTestResult(data);
    });

    state.eventSource.addEventListener('run_complete', (e) => {
        const data = JSON.parse(e.data);
        handleRunComplete(data);
    });

    state.eventSource.addEventListener('cancelled', () => {
        setStatus('idle', 'Cancelled');
        stopRun();
    });

    state.eventSource.addEventListener('error', (e) => {
        const data = e.data ? JSON.parse(e.data) : {};
        console.error('SSE error:', data);
        setStatus('failed', 'Error');
        stopRun();
    });

    state.eventSource.onerror = () => {
        // SSE connection closed (normal after run_complete)
        if (state.running) {
            state.eventSource.close();
        }
    };
}

function handleTestResult(data) {
    state.completed++;

    // Update cell
    const testInfo = state.testMap[data.nodeid];
    if (testInfo) {
        testInfo.status = data.status;
        testInfo.element.className = `test-cell ${data.status}`;
    }

    // Update counters
    if (data.status === 'passed') state.passed++;
    else if (data.status === 'failed' || data.status === 'error') state.failed++;
    else if (data.status === 'skipped') state.skipped++;

    // Track per-category
    const cat = data.category || 'other';
    if (!state.categoryResults[cat]) state.categoryResults[cat] = { passed: 0, failed: 0, total: 0 };
    state.categoryResults[cat].total++;
    if (data.status === 'passed') state.categoryResults[cat].passed++;
    else if (data.status === 'failed' || data.status === 'error') state.categoryResults[cat].failed++;

    // Update progress
    const pct = state.totalDiscovered > 0 ? (state.completed / state.totalDiscovered * 100) : 0;
    document.getElementById('progressFill').style.width = `${pct}%`;

    updateSummary();
}

function handleRunComplete(data) {
    setStatus(data.failed > 0 ? 'failed' : 'passed',
              data.failed > 0 ? `${data.failed} Failed` : 'All Passed');

    document.getElementById('timeValue').textContent = `${data.duration}s`;
    document.getElementById('lastRunTime').textContent =
        `Last run: ${new Date(data.timestamp).toLocaleTimeString()} (${data.category})`;

    // Store per-test details from JSON report
    if (data.test_details) {
        state.testDetails = data.test_details;
    }

    // Show failures
    if (data.failures && data.failures.length > 0) {
        showFailures(data.failures);
    }

    // Update breakdown
    renderBreakdown();

    // Reload trend
    loadTrend();

    stopRun();
}

function stopRun() {
    state.running = false;
    if (state.eventSource) {
        state.eventSource.close();
        state.eventSource = null;
    }
    document.getElementById('btnCancel').disabled = true;
    document.querySelectorAll('.controls .btn:not(.btn-danger)').forEach(b => b.disabled = false);
}

async function cancelTests() {
    try {
        await fetch('/api/run-tests/cancel', { method: 'POST' });
    } catch (e) {
        console.error('Cancel failed:', e);
    }
    setStatus('idle', 'Cancelled');
    stopRun();
}

/* ========== UI Helpers ========== */
function setStatus(type, text) {
    const pill = document.getElementById('statusPill');
    pill.className = `status-pill ${type}`;
    document.getElementById('statusText').textContent = text;
}

function updateSummary() {
    document.getElementById('totalCount').textContent = state.totalDiscovered || '-';
    document.getElementById('passedCount').textContent = state.passed || '0';
    document.getElementById('failedCount').textContent = state.failed || '0';
    document.getElementById('skippedCount').textContent = state.skipped || '0';
}

function showFailures(failures) {
    const section = document.getElementById('failuresSection');
    const container = document.getElementById('failuresContainer');
    section.style.display = 'block';
    container.innerHTML = '';

    for (const f of failures) {
        const card = document.createElement('div');
        card.className = 'failure-card';

        const header = document.createElement('div');
        header.className = 'failure-header';

        const name = document.createElement('span');
        name.className = 'failure-name';
        name.textContent = f.nodeid;
        header.appendChild(name);

        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = 'Copy';
        copyBtn.onclick = () => {
            navigator.clipboard.writeText(f.error || '');
            copyBtn.textContent = 'Copied!';
            setTimeout(() => copyBtn.textContent = 'Copy', 1500);
        };
        header.appendChild(copyBtn);

        card.appendChild(header);

        if (f.error) {
            const err = document.createElement('div');
            err.className = 'failure-error';
            err.textContent = f.error;
            card.appendChild(err);
        }

        container.appendChild(card);
    }
}

/* ========== Category Breakdown ========== */
function renderBreakdown() {
    const section = document.getElementById('breakdownSection');
    const bar = document.getElementById('breakdownBar');
    const legend = document.getElementById('breakdownLegend');

    const cats = state.categoryResults;
    const catNames = Object.keys(cats);
    if (catNames.length === 0) return;

    section.style.display = 'block';
    bar.innerHTML = '';
    legend.innerHTML = '';

    const total = Object.values(cats).reduce((sum, c) => sum + c.total, 0);
    const colors = {
        unit: '#2383e2',
        api: '#7c3aed',
        stress: '#ff9800',
        integration: '#009688',
        security: '#e53935',
        e2e: '#4caf50',
        other: '#9e9e9e',
    };

    for (const cat of catNames) {
        const c = cats[cat];
        const pct = total > 0 ? (c.total / total * 100) : 0;
        const color = colors[cat] || '#9e9e9e';

        const seg = document.createElement('div');
        seg.className = 'breakdown-segment';
        seg.style.width = `${pct}%`;
        seg.style.background = color;
        if (pct > 8) seg.textContent = `${c.total}`;
        bar.appendChild(seg);

        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `
            <span class="legend-dot" style="background:${color}"></span>
            ${cat} (${c.passed}/${c.total})
        `;
        legend.appendChild(item);
    }
}

/* ========== Trend Chart ========== */
async function loadTrend() {
    try {
        const r = await fetch('/api/test-history?limit=20');
        const data = await r.json();
        renderTrend(data.runs || []);
    } catch (e) {
        console.error('Failed to load trend:', e);
    }
}

function renderTrend(runs) {
    const container = document.getElementById('trendChart');
    if (runs.length === 0) {
        container.innerHTML = '<div class="trend-empty">Run tests to build trend data</div>';
        return;
    }

    const W = container.clientWidth - 32;
    const H = container.clientHeight - 32;
    const maxTotal = Math.max(...runs.map(r => r.total || 1));
    const step = W / Math.max(runs.length - 1, 1);

    // Build SVG
    let passedPoints = [];
    let failedPoints = [];

    for (let i = 0; i < runs.length; i++) {
        const x = 16 + i * step;
        const yPassed = 16 + H - (runs[i].passed / maxTotal * H);
        const yFailed = 16 + H - ((runs[i].failed || 0) / maxTotal * H);
        passedPoints.push(`${x},${yPassed}`);
        failedPoints.push(`${x},${yFailed}`);
    }

    // Passed area
    const passedArea = `${16},${16 + H} ${passedPoints.join(' ')} ${16 + (runs.length-1)*step},${16+H}`;
    const failedArea = `${16},${16 + H} ${failedPoints.join(' ')} ${16 + (runs.length-1)*step},${16+H}`;

    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const gridColor = isDark ? '#333' : '#e8e8e4';

    container.innerHTML = `
        <svg class="trend-svg" viewBox="0 0 ${W+32} ${H+32}" preserveAspectRatio="none">
            <!-- Grid lines -->
            <line x1="16" y1="${16+H}" x2="${W+16}" y2="${16+H}" stroke="${gridColor}" stroke-width="1"/>
            <line x1="16" y1="${16+H/2}" x2="${W+16}" y2="${16+H/2}" stroke="${gridColor}" stroke-width="0.5" stroke-dasharray="4"/>
            <line x1="16" y1="16" x2="${W+16}" y2="16" stroke="${gridColor}" stroke-width="0.5" stroke-dasharray="4"/>

            <!-- Passed area -->
            <polygon points="${passedArea}" fill="rgba(76,175,80,0.15)" />
            <polyline points="${passedPoints.join(' ')}" fill="none" stroke="#4caf50" stroke-width="2"/>

            <!-- Failed area -->
            <polygon points="${failedArea}" fill="rgba(229,57,53,0.1)" />
            <polyline points="${failedPoints.join(' ')}" fill="none" stroke="#e53935" stroke-width="2" stroke-dasharray="4"/>

            <!-- Dots -->
            ${passedPoints.map(p => {
                const [x, y] = p.split(',');
                return `<circle cx="${x}" cy="${y}" r="3" fill="#4caf50"/>`;
            }).join('')}
            ${failedPoints.map(p => {
                const [x, y] = p.split(',');
                return `<circle cx="${x}" cy="${y}" r="3" fill="#e53935"/>`;
            }).join('')}
        </svg>
    `;
}

/* ========== Live Terminal ========== */
function toggleTerminal() {
    const toggle = document.getElementById('terminalToggle');
    const body = document.getElementById('terminalBody');
    toggle.classList.toggle('open');
    body.classList.toggle('open');
}

function openTerminal() {
    document.getElementById('terminalToggle').classList.add('open');
    document.getElementById('terminalBody').classList.add('open');
}

function clearTerminal() {
    document.getElementById('terminalContent').innerHTML = '';
}

function appendTerminalLine(line, elapsed) {
    const content = document.getElementById('terminalContent');
    const el = document.createElement('div');

    // Color-code lines
    let cls = '';
    if (line.includes(' PASSED')) cls = 'line-pass';
    else if (line.includes(' FAILED') || line.includes(' ERROR')) cls = 'line-fail';
    else if (line.includes(' SKIPPED')) cls = 'line-skip';
    else if (line.startsWith('FAILED') || line.startsWith('=')) cls = 'line-info';

    const timeStr = `[${elapsed}s]`;
    el.innerHTML = `<span class="line-time">${timeStr}</span> <span class="${cls}">${escapeHtml(line)}</span>`;
    content.appendChild(el);

    // Auto-scroll
    const body = document.getElementById('terminalBody');
    body.scrollTop = body.scrollHeight;
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

/* ========== Detail Panel ========== */
async function openDetail(nodeid) {
    const panel = document.getElementById('detailPanel');
    const overlay = document.getElementById('detailOverlay');
    const title = document.getElementById('detailTitle');
    const body = document.getElementById('detailBody');

    // Parse nodeid parts
    const parts = nodeid.split('::');
    const file = parts[0] || '';
    const className = parts.length === 3 ? parts[1] : '';
    const methodName = parts[parts.length - 1] || '';

    title.textContent = methodName;

    // Build initial content with what we have
    const testInfo = state.testMap[nodeid] || {};
    const runDetail = state.testDetails[nodeid] || {};
    const status = runDetail.outcome || testInfo.status || 'pending';

    body.innerHTML = `
        <div class="detail-row">
            <div class="detail-label">Status</div>
            <div class="detail-value"><span class="detail-badge ${status}">${status}</span></div>
        </div>
        <div class="detail-row">
            <div class="detail-label">File</div>
            <div class="detail-value"><a class="detail-file-link" href="vscode://file/${window.location.origin}/../${file}" title="Open in VS Code">${file}</a></div>
        </div>
        ${className ? `<div class="detail-row"><div class="detail-label">Class</div><div class="detail-value">${className}</div></div>` : ''}
        <div class="detail-row">
            <div class="detail-label">Test</div>
            <div class="detail-value" style="font-family:monospace;font-size:13px;">${methodName}</div>
        </div>
        ${runDetail.duration ? `<div class="detail-row"><div class="detail-label">Duration</div><div class="detail-value">${runDetail.duration}s</div></div>` : ''}
        <div class="detail-row" id="detailDocstring"><div class="detail-label">Loading details...</div></div>
    `;

    panel.classList.add('open');
    overlay.classList.add('open');

    // Fetch full detail from backend
    try {
        const r = await fetch(`/api/test-detail?nodeid=${encodeURIComponent(nodeid)}`);
        const detail = await r.json();

        let extraHtml = '';

        if (detail.docstring) {
            extraHtml += `
                <div class="detail-row">
                    <div class="detail-label">Description</div>
                    <div class="detail-docstring">${escapeHtml(detail.docstring)}</div>
                </div>`;
        }

        if (detail.class_docstring) {
            extraHtml += `
                <div class="detail-row">
                    <div class="detail-label">Class Description</div>
                    <div class="detail-docstring">${escapeHtml(detail.class_docstring)}</div>
                </div>`;
        }

        if (detail.lineno) {
            extraHtml += `
                <div class="detail-row">
                    <div class="detail-label">Line</div>
                    <div class="detail-value">${detail.lineno}</div>
                </div>`;
        }

        if (runDetail.error) {
            extraHtml += `
                <div class="detail-row">
                    <div class="detail-label">Error</div>
                    <div class="detail-error">${escapeHtml(runDetail.error)}</div>
                </div>`;
        }

        if (detail.source) {
            extraHtml += `
                <div class="detail-row">
                    <div class="detail-label">Source Code</div>
                    <div class="detail-source">${escapeHtml(detail.source)}</div>
                </div>`;
        }

        // Replace the loading placeholder
        const placeholder = document.getElementById('detailDocstring');
        if (placeholder) placeholder.outerHTML = extraHtml;
    } catch (e) {
        const placeholder = document.getElementById('detailDocstring');
        if (placeholder) placeholder.innerHTML = `<div class="detail-label" style="color:var(--red);">Failed to load details</div>`;
    }
}

function closeDetail() {
    document.getElementById('detailPanel').classList.remove('open');
    document.getElementById('detailOverlay').classList.remove('open');
}

/* ========== AI Test Creator ========== */
function openTestCreator() {
    document.getElementById('aiModal').classList.add('open');
    document.getElementById('aiDescription').value = '';
    document.getElementById('aiCodeGroup').style.display = 'none';
    document.getElementById('aiFilenameGroup').style.display = 'none';
    document.getElementById('btnSaveRun').style.display = 'none';
    document.getElementById('btnGenerate').disabled = false;
    document.getElementById('aiStatus').textContent = '';
    document.getElementById('aiCodePreview').textContent = '';
    document.getElementById('aiCodePreview').contentEditable = 'false';
}

function closeTestCreator() {
    document.getElementById('aiModal').classList.remove('open');
}

async function generateTest() {
    const desc = document.getElementById('aiDescription').value.trim();
    if (!desc) return;

    const category = document.getElementById('aiCategory').value;
    const btn = document.getElementById('btnGenerate');
    const status = document.getElementById('aiStatus');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Generating...';
    status.textContent = 'Calling AI...';

    try {
        const r = await fetch('/api/generate-test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ description: desc, category }),
        });
        const data = await r.json();

        if (data.error) {
            status.textContent = `Error: ${data.error}`;
            btn.disabled = false;
            btn.textContent = 'Generate';
            return;
        }

        // Show the generated code
        document.getElementById('aiCodePreview').textContent = data.code;
        document.getElementById('aiCodeGroup').style.display = 'block';
        document.getElementById('aiFilename').value = data.suggested_filename;
        document.getElementById('aiFilenameGroup').style.display = 'block';
        document.getElementById('btnSaveRun').style.display = 'inline-flex';
        status.textContent = 'Generated successfully. Review and save.';
    } catch (e) {
        status.textContent = `Error: ${e.message}`;
    }

    btn.disabled = false;
    btn.textContent = 'Regenerate';
}

function toggleCodeEdit() {
    const preview = document.getElementById('aiCodePreview');
    const editable = preview.contentEditable === 'true';
    preview.contentEditable = editable ? 'false' : 'true';
    if (!editable) preview.focus();
}

async function saveAndRunTest() {
    const code = document.getElementById('aiCodePreview').textContent;
    const filename = document.getElementById('aiFilename').value.trim();
    const category = document.getElementById('aiCategory').value;
    const status = document.getElementById('aiStatus');

    if (!code || !filename) {
        status.textContent = 'Missing code or filename.';
        return;
    }

    status.textContent = 'Saving...';

    try {
        const r = await fetch('/api/save-test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code, filename, category }),
        });
        const data = await r.json();

        if (data.error) {
            status.textContent = `Error: ${data.error}`;
            return;
        }

        status.textContent = `Saved to ${data.path}. Running...`;
        closeTestCreator();

        // Run the new test
        setTimeout(() => runTests(category), 500);
    } catch (e) {
        status.textContent = `Error: ${e.message}`;
    }
}

/* ========== Init ========== */
document.addEventListener('DOMContentLoaded', () => {
    loadTrend();
    // Auto-discover tests
    discoverTests('all');
});
</script>
</body>
</html>
